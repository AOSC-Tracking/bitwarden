"use strict";(self.webpackChunk_bitwarden_web_vault=self.webpackChunk_bitwarden_web_vault||[]).push([[146],{7146:(e,t,i)=>{i.r(t),i.d(t,{MigrateFromLegacyEncryptionComponent:()=>j});var r=i(98645),n=i(71146),s=i(76736),o=i(99042),c=i(58691),a=i(82558),y=i(11581),u=i(27646),d=i(81399),l=i(41412),p=i(79971),h=i(24852),v=i(97360),f=i(47244),m=i(55602),g=i(76528),S=i(85540),w=i(4871),b=i(92236),U=i(23031),_=i(92649),A=i(58172),Z=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{a(r.next(e))}catch(t){s(t)}}function c(e){try{a(r.throw(e))}catch(t){s(t)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((r=r.apply(e,t||[])).next())}))};class K{constructor(e,t,i,r,n,s,o,c,a,y,u,d){this.organizationService=e,this.organizationApiService=t,this.organizationUserService=i,this.emergencyAccessService=r,this.apiService=n,this.cryptoService=s,this.encryptService=o,this.syncService=c,this.cipherService=a,this.folderService=y,this.sendService=u,this.stateService=d}createNewUserKey(e){return Z(this,void 0,void 0,(function*(){const t=yield this.cryptoService.makeMasterKey(e,yield this.stateService.getEmail(),yield this.stateService.getKdfType(),yield this.stateService.getKdfConfig());if(!t)throw new Error("Invalid master password");if(!(yield this.cryptoService.isLegacyUser(t)))throw new Error("Invalid master password or user may not be legacy");return yield this.cryptoService.setMasterKey(t),yield this.cryptoService.makeUserKey(t)}))}updateKeysAndEncryptedData(e,t,i){return Z(this,void 0,void 0,(function*(){const r=new y.n;return r.key=i.encryptedString,r.masterPasswordHash=yield this.cryptoService.hashMasterKey(e,yield this.cryptoService.getOrDeriveMasterKey(e)),yield this.syncService.fullSync(!0),r.privateKey=yield this.encryptPrivateKey(t),r.folders=yield this.encryptFolders(t),r.ciphers=yield this.encryptCiphers(t),r.sends=yield this.encryptSends(t),this.apiService.postAccountKey(r)}))}updateEmergencyAccesses(e){return this.emergencyAccessService.rotate(e)}updateAllAdminRecoveryKeys(e,t){return Z(this,void 0,void 0,(function*(){const i=yield this.organizationService.getAll();for(const r of i){if(!r.resetPasswordEnrolled)continue;const i=yield this.organizationApiService.getKeys(r.id),n=u.c.fromB64ToArray(null==i?void 0:i.publicKey),s=yield this.cryptoService.rsaEncrypt(t.key,n),o=new a.w;o.resetPasswordKey=s.encryptedString,o.masterPasswordHash=yield this.cryptoService.hashMasterKey(e,yield this.cryptoService.getOrDeriveMasterKey(e)),yield this.organizationUserService.putOrganizationUserResetPasswordEnrollment(r.id,r.userId,o)}}))}encryptPrivateKey(e){return Z(this,void 0,void 0,(function*(){const t=yield this.cryptoService.getPrivateKey();if(t)return(yield this.encryptService.encrypt(t,e)).encryptedString}))}encryptFolders(e){return Z(this,void 0,void 0,(function*(){const t=yield(0,o.z)(this.folderService.folderViews$);if(t)return yield Promise.all(t.map((t=>Z(this,void 0,void 0,(function*(){const i=yield this.folderService.encrypt(t,e);return new p.C(i)})))))}))}encryptCiphers(e){return Z(this,void 0,void 0,(function*(){const t=yield this.cipherService.getAllDecrypted();if(t)return yield Promise.all(t.map((t=>Z(this,void 0,void 0,(function*(){const i=yield this.cipherService.encrypt(t,e);return new l.K(i)})))))}))}encryptSends(e){return Z(this,void 0,void 0,(function*(){const t=yield(0,o.z)(this.sendService.sends$);if(t)return yield Promise.all(t.map((t=>Z(this,void 0,void 0,(function*(){var i;const r=yield this.encryptService.decryptToBytes(t.key,null);return t.key=null!==(i=yield this.encryptService.encrypt(r,e))&&void 0!==i?i:t.key,new d.N(t)})))))}))}}K.ɵfac=function(e){return new(e||K)(h.LFG(c.Mn),h.LFG(v.M),h.LFG(f.t),h.LFG(s.d),h.LFG(m.s),h.LFG(g.$),h.LFG(S.U),h.LFG(w._),h.LFG(b.u),h.LFG(U.s),h.LFG(_.N),h.LFG(A.b))},K.ɵprov=h.Yz7({token:K,factory:K.ɵfac});var k=i(78627),L=i(99721),G=i(34961),P=i(66459),T=i(62374),x=i(46246),F=i(36338),q=i(81974),E=i(24083),z=i(24637),M=i(11512),C=i(54666),I=i(1e4),O=i(36179),D=i(21656),Y=i(28315),B=i(82933),N=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{a(r.next(e))}catch(t){s(t)}}function c(e){try{a(r.throw(e))}catch(t){s(t)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,c)}a((r=r.apply(e,t||[])).next())}))};class j{constructor(e,t,i,n,s,o){this.i18nService=e,this.platformUtilsService=t,this.migrationService=i,this.cryptoService=n,this.messagingService=s,this.logService=o,this.formGroup=new r.cw({masterPassword:new r.NI("",[r.kI.required])}),this.submit=()=>N(this,void 0,void 0,(function*(){if(this.formGroup.markAsTouched(),this.formGroup.invalid)return;if(yield this.cryptoService.hasUserKey())throw this.messagingService.send("logout"),new Error("User key already exists, cannot migrate legacy encryption.");const e=this.formGroup.value.masterPassword;try{const[t,i]=yield this.migrationService.createNewUserKey(e);yield this.migrationService.updateAllAdminRecoveryKeys(e,t),yield this.migrationService.updateEmergencyAccesses(t),yield this.migrationService.updateKeysAndEncryptedData(e,t,i),this.platformUtilsService.showToast("success",this.i18nService.t("keyUpdated"),this.i18nService.t("logBackInOthersToo"),{timeout:15e3}),this.messagingService.send("logout")}catch(t){throw this.logService.error(t),t}}))}}j.ɵfac=function(e){return new(e||j)(h.Y36(k.D),h.Y36(L.P),h.Y36(K),h.Y36(g.$),h.Y36(G.o),h.Y36(P.$))},j.ɵcmp=h.Xpm({type:j,selectors:[["ng-component"]],standalone:!0,features:[h._Bn([K]),h.jDz],decls:43,vars:20,consts:[[3,"formGroup","bitSubmit"],[1,"tw-mt-12","tw-flex","tw-justify-center"],[1,"tw-max-w-xl"],["bitTypography","h1",1,"tw-mb-4","tw-text-center"],[1,"tw-block","tw-rounded","tw-border","tw-border-solid","tw-border-secondary-300","tw-bg-background","tw-p-8"],["href","https://bitwarden.com/help/account-encryption-key/#rotate-your-encryption-key","target","_blank","rel","noopener"],["type","warning"],["id","masterPassword","bitInput","","type","password","formControlName","masterPassword","appAutofocus",""],["type","button","bitIconButton","","bitSuffix","","bitPasswordInputToggle",""],["type","submit","bitButton","","bitFormButton","","buttonType","primary","block",""]],template:function(e,t){1&e&&(h.TgZ(0,"form",0),h._uU(1,"\n  "),h.TgZ(2,"div",1),h._uU(3,"\n    "),h.TgZ(4,"div",2),h._uU(5,"\n      "),h.TgZ(6,"h1",3),h._uU(7),h.ALo(8,"i18n"),h.qZA(),h._uU(9,"\n      "),h.TgZ(10,"div",4),h._uU(11,"\n        "),h.TgZ(12,"p"),h._uU(13),h.ALo(14,"i18n"),h.TgZ(15,"a",5),h._uU(16),h.ALo(17,"i18n"),h.qZA(),h._uU(18,"\n        "),h.qZA(),h._uU(19,"\n        "),h.TgZ(20,"bit-callout",6),h._uU(21),h.ALo(22,"i18n"),h.qZA(),h._uU(23,"\n\n        "),h.TgZ(24,"bit-form-field"),h._uU(25,"\n          "),h.TgZ(26,"bit-label"),h._uU(27),h.ALo(28,"i18n"),h.qZA(),h._uU(29,"\n          "),h._UZ(30,"input",7),h._uU(31,"\n          "),h._UZ(32,"button",8),h._uU(33,"\n        "),h.qZA(),h._uU(34,"\n        "),h.TgZ(35,"button",9),h._uU(36),h.ALo(37,"i18n"),h.qZA(),h._uU(38,"\n      "),h.qZA(),h._uU(39,"\n    "),h.qZA(),h._uU(40,"\n  "),h.qZA(),h._uU(41,"\n"),h.qZA(),h._uU(42,"\n")),2&e&&(h.Q6J("formGroup",t.formGroup)("bitSubmit",t.submit),h.xp6(7),h.Oqu(h.lcZ(8,8,"updateEncryptionKey")),h.xp6(6),h.hij("\n          ",h.lcZ(14,10,"updateEncryptionSchemeDesc"),"\n          "),h.xp6(3),h.Oqu(h.lcZ(17,12,"learnMore")),h.xp6(5),h.Oqu(h.lcZ(22,14,"updateEncryptionKeyWarning")),h.xp6(6),h.Oqu(h.lcZ(28,16,"masterPass")),h.xp6(9),h.hij("\n          ",h.lcZ(37,18,"updateEncryptionKey"),"\n        "))},dependencies:[n.m,r._Y,r.Fj,r.JJ,r.JL,r.sg,r.u,T.U,x.b,F.u,q.r,E.O,z.d,M.G,C.w,I.e,O.u,D.Q,Y.t,B.C,s.x],encapsulation:2})}}]);
//# sourceMappingURL=146.2e7dd6ff9278973dceb4.js.map